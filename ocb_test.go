package ocb

import (
	"bytes"
	"crypto/aes"
	"math/rand"
	"testing"
)

// draft-irtf-cfrg-ocb-00 vectors

var (
	tK  = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F")
	tN  = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B")
	ta0 = []byte("")
	tp0 = []byte("")
	tc0 = []byte("\x19\x7B\x9C\x3C\x44\x1D\x3C\x83\xEA\xFB\x2B\xEF\x63\x3B\x91\x82")
	ta1 = []byte("\x00\x01\x02\x03\x04\x05\x06\x07")
	tp1 = []byte("\x00\x01\x02\x03\x04\x05\x06\x07")
	tc1 = []byte("\x92\xB6\x57\x13\x0A\x74\xB8\x5A\x16\xDC\x76\xA4\x6D\x47\xE1\xEA\xD5\x37\x20\x9E\x8A\x96\xD1\x4E")
	ta2 = []byte("\x00\x01\x02\x03\x04\x05\x06\x07")
	tp2 = []byte("")
	tc2 = []byte("\x98\xB9\x15\x52\xC8\xC0\x09\x18\x50\x44\xE3\x0A\x6E\xB2\xFE\x21")
	ta3 = []byte("")
	tp3 = []byte("\x00\x01\x02\x03\x04\x05\x06\x07")
	tc3 = []byte("\x92\xB6\x57\x13\x0A\x74\xB8\x5A\x97\x1E\xFF\xCA\xE1\x9A\xD4\x71\x6F\x88\xE8\x7B\x87\x1F\xBE\xED")
	ta4 = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F")
	tp4 = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F")
	tc4 = []byte("\xBE\xA5\xE8\x79\x8D\xBE\x71\x10\x03\x1C\x14\x4D\xA0\xB2\x61\x22\x77\x6C\x99\x24\xD6\x72\x3A\x1F\xC4\x52\x45\x32\xAC\x3E\x5B\xEB")
	ta5 = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F")
	tp5 = []byte("")
	tc5 = []byte("\x7D\xDB\x8E\x6C\xEA\x68\x14\x86\x62\x12\x50\x96\x19\xB1\x9C\xC6")
	ta6 = []byte("")
	tp6 = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F")
	tc6 = []byte("\xBE\xA5\xE8\x79\x8D\xBE\x71\x10\x03\x1C\x14\x4D\xA0\xB2\x61\x22\x13\xCC\x8B\x74\x78\x07\x12\x1A\x4C\xBB\x3E\x4B\xD6\xB4\x56\xAF")
	ta7 = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17")
	tp7 = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17")
	tc7 = []byte("\xBE\xA5\xE8\x79\x8D\xBE\x71\x10\x03\x1C\x14\x4D\xA0\xB2\x61\x22\xFC\xFC\xEE\x7A\x2A\x8D\x4D\x48\x5F\xA9\x4F\xC3\xF3\x88\x20\xF1\xDC\x3F\x3D\x1F\xD4\xE5\x5E\x1C")
	ta8 = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17")
	tp8 = []byte("")
	tc8 = []byte("\x28\x20\x26\xDA\x30\x68\xBC\x9F\xA1\x18\x68\x1D\x55\x9F\x10\xF6")
	ta9 = []byte("")
	tp9 = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17")
	tc9 = []byte("\xBE\xA5\xE8\x79\x8D\xBE\x71\x10\x03\x1C\x14\x4D\xA0\xB2\x61\x22\xFC\xFC\xEE\x7A\x2A\x8D\x4D\x48\x6E\xF2\xF5\x25\x87\xFD\xA0\xED\x97\xDC\x7E\xED\xE2\x41\xDF\x68")
	taa = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1A\x1B\x1C\x1D\x1E\x1F")
	tpa = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1A\x1B\x1C\x1D\x1E\x1F")
	tca = []byte("\xBE\xA5\xE8\x79\x8D\xBE\x71\x10\x03\x1C\x14\x4D\xA0\xB2\x61\x22\xCE\xAA\xB9\xB0\x5D\xF7\x71\xA6\x57\x14\x9D\x53\x77\x34\x63\xCB\xB2\xA0\x40\xDD\x3B\xD5\x16\x43\x72\xD7\x6D\x7B\xB6\x82\x42\x40")
	tab = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1A\x1B\x1C\x1D\x1E\x1F")
	tpb = []byte("")
	tcb = []byte("\xE1\xE0\x72\x63\x3B\xAD\xE5\x1A\x60\xE8\x59\x51\xD9\xC4\x2A\x1B")
	tac = []byte("")
	tpc = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1A\x1B\x1C\x1D\x1E\x1F")
	tcc = []byte("\xBE\xA5\xE8\x79\x8D\xBE\x71\x10\x03\x1C\x14\x4D\xA0\xB2\x61\x22\xCE\xAA\xB9\xB0\x5D\xF7\x71\xA6\x57\x14\x9D\x53\x77\x34\x63\xCB\x4A\x3B\xAE\x82\x44\x65\xCF\xDA\xF8\xC4\x1F\xC5\x0C\x7D\xF9\xD9")
	tad = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1A\x1B\x1C\x1D\x1E\x1F\x20\x21\x22\x23\x24\x25\x26\x27")
	tpd = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1A\x1B\x1C\x1D\x1E\x1F\x20\x21\x22\x23\x24\x25\x26\x27")
	tcd = []byte("\xBE\xA5\xE8\x79\x8D\xBE\x71\x10\x03\x1C\x14\x4D\xA0\xB2\x61\x22\xCE\xAA\xB9\xB0\x5D\xF7\x71\xA6\x57\x14\x9D\x53\x77\x34\x63\xCB\x68\xC6\x57\x78\xB0\x58\xA6\x35\x65\x9C\x62\x32\x11\xDE\xEA\x0D\xE3\x0D\x2C\x38\x18\x79\xF4\xC8")
	tae = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1A\x1B\x1C\x1D\x1E\x1F\x20\x21\x22\x23\x24\x25\x26\x27")
	tpe = []byte("")
	tce = []byte("\x7A\xEB\x7A\x69\xA1\x68\x7D\xD0\x82\xCA\x27\xB0\xD9\xA3\x70\x96")
	taf = []byte("")
	tpf = []byte("\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1A\x1B\x1C\x1D\x1E\x1F\x20\x21\x22\x23\x24\x25\x26\x27")
	tcf = []byte("\xBE\xA5\xE8\x79\x8D\xBE\x71\x10\x03\x1C\x14\x4D\xA0\xB2\x61\x22\xCE\xAA\xB9\xB0\x5D\xF7\x71\xA6\x57\x14\x9D\x53\x77\x34\x63\xCB\x68\xC6\x57\x78\xB0\x58\xA6\x35\x06\x0C\x84\x67\xF4\xAB\xAB\x5E\x8B\x3C\x20\x67\xA2\xE1\x15\xDC")
)

func TestVectors(test *testing.T) {
	k := tK
	n := []byte{
		0x00, 0x01, 0x02, 0x03, 0x04, 0x05,
		0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B,
	}

	ac, _ := aes.NewCipher(k)
	aead, err := NewOCB(ac, 16)
	if err != nil {
		test.Fatal(err)
	}

	try := func(a, p, c []byte) {
		ov := aead.Seal(nil, n, p, a)
		if bytes.Compare(ov, c) != 0 {
			test.Errorf("%X != %X", ov, c)
		}

		px, err := aead.Open(nil, n, ov, a)
		if err != nil {
			test.Fatal(err)
		}

		if bytes.Compare(px, p) != 0 {
			test.Errorf("%X != %X", px, p)
		}

		// skip the vector with no actual ciphertext
		if len(ov) > 0 {
			// flip 100 random bits, verify mac fails
			for j := 0; j < 100; j++ {
				idx := rand.Uint32() % uint32(len(ov))
				bit := rand.Uint32() % 8
				old := ov[idx]
				ov[idx] ^= (1 << bit)
				_, err := aead.Open(nil, n, ov, a)
				if err == nil {
					test.Errorf("MAC false")
				}
				ov[idx] = old
			}
		}
	}

	a := ta0
	p := tp0
	c := tc0
	try(a, p, c)
	test.Log("beat 0")
	a = ta1
	p = tp1
	c = tc1
	try(a, p, c)
	test.Log("beat 1")
	a = ta2
	p = tp2
	c = tc2
	try(a, p, c)
	test.Logf("beat 2\n")
	a = ta3
	p = tp3
	c = tc3
	try(a, p, c)
	test.Logf("beat 3\n")
	a = ta4
	p = tp4
	c = tc4
	try(a, p, c)
	test.Logf("beat 4\n")
	a = ta5
	p = tp5
	c = tc5
	try(a, p, c)
	test.Logf("beat 5\n")
	a = ta6
	p = tp6
	c = tc6
	try(a, p, c)
	test.Logf("beat 6\n")
	a = ta7
	p = tp7
	c = tc7
	try(a, p, c)
	test.Logf("beat 7\n")
	a = ta8
	p = tp8
	c = tc8
	try(a, p, c)
	test.Logf("beat 8\n")
	a = ta9
	p = tp9
	c = tc9
	try(a, p, c)
	test.Logf("beat 9\n")
	a = taa
	p = tpa
	c = tca
	try(a, p, c)
	test.Logf("beat a\n")
	a = tab
	p = tpb
	c = tcb
	try(a, p, c)
	test.Logf("beat b\n")
	a = tac
	p = tpc
	c = tcc
	try(a, p, c)
	test.Logf("beat c\n")
	a = tad
	p = tpd
	c = tcd
	try(a, p, c)
	test.Logf("beat d\n")
	a = tae
	p = tpe
	c = tce
	try(a, p, c)
	test.Logf("beat e\n")
	a = taf
	p = tpf
	c = tcf
	try(a, p, c)
	test.Logf("beat f\n")
}
